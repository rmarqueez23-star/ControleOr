<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carteira de Investimentos - omeuplannerfinanceiro</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        .portfolio-grid {
            /* Usando classes do Tailwind para o layout de grid */
            @apply grid grid-cols-1 md:grid-cols-3 gap-8; 
        }
        .portfolio-left {
            /* Coluna para resumo e distribuição (2/3 no desktop) */
            @apply md:col-span-1 space-y-8;
        }
        .portfolio-right {
             /* Coluna para tabela detalhada (2/3 no desktop) */
            @apply md:col-span-2;
        }
        .distribuicao-item {
            @apply flex justify-between py-2 border-b border-border-default last:border-b-0;
        }
    </style>
</head>
<body class="bg-bg-main text-text-light font-sans antialiased">

    <header class="sticky top-0 z-10 flex items-center justify-between border-b border-border-default bg-bg-card px-8 py-4 shadow-smooth">
        <div class="logo">
            omeuplannerfinanceiro
        </div>
        <nav class="main-nav hidden md:flex space-x-8">
            <a href="index.html" class="text-text-light font-semibold hover:text-brand-primary transition duration-200">Dashboard</a>
            <a href="lancamentos.html" class="text-text-light font-semibold hover:text-brand-primary transition duration-200">Lançamentos</a> 
            <a href="metas.html" class="text-text-light font-semibold hover:text-brand-primary transition duration-200">Metas</a>
            <a href="investimentos.html" class="text-brand-primary font-semibold hover:text-opacity-80 transition duration-200">Investimentos</a> 
        </nav>
        <div class="flex items-center space-x-4">
            <span class="icon text-text-light cursor-pointer hover:text-brand-primary transition duration-200">&#x2699;</span>
            <div class="w-8 h-8 bg-neutral-mid rounded-full cursor-pointer"></div>
        </div>
    </header>

    <main class="dashboard-content p-8 bg-bg-main">
        <h1 class="text-3xl font-bold text-text-light mb-6">Minha Carteira de Investimentos</h1>
        
        <button class="bg-brand-primary text-white font-bold py-2 px-4 rounded hover:bg-orange-700 transition duration-200 mb-8" onclick="openAtivoModal('new')">+ Adicionar Novo Ativo</button>

        <section class="portfolio-grid">
            
            <div class="portfolio-left">
                <div class="bg-bg-card p-6 rounded-lg shadow-smooth border border-border-default space-y-4" id="carteira-resumo-card">
                    <h2 class="text-xl font-semibold text-text-light m-0">Visão Geral da Carteira</h2>
                    
                    <div class="border-b border-border-default pb-4">
                        <p class="text-text-dim text-sm">Patrimônio Total Investido (Custo):</p>
                        <p class="text-status-success font-extrabold text-3xl mt-1" id="total-patrimonio">R$ 0,00</p>
                    </div>
                    
                    <h3 class="text-text-light font-semibold m-0">Distribuição por Classe de Ativo</h3>
                    
                    <div class="bg-bg-surface h-36 rounded-lg flex items-center justify-center text-text-dim border border-border-default">
                        [Gráfico de Distribuição (Simulado)]
                    </div>

                    <div id="distribuicao-container" class="pt-2">
                        </div>
                </div>

                <section id="investimento-kpi-bottom" class="bg-bg-card p-6 rounded-lg shadow-smooth border border-border-default text-center">
                    <h3 class="text-text-dim text-sm mb-1">Gastos Planejados (Investimento) do Mês</h3>
                    <p class="text-brand-primary font-extrabold text-3xl">R$ 1.500,00</p>
                </section>
            </div>


            <div class="portfolio-right bg-bg-card p-6 rounded-lg shadow-smooth border border-border-default">
                <h2 class="text-xl font-semibold text-text-light mb-4">Detalhes dos Ativos em Carteira</h2>
                
                <div class="overflow-x-auto">
                    <table id="table-ativos" class="w-full text-sm text-text-light whitespace-nowrap">
                        <thead>
                            <tr class="border-b-2 border-border-default text-text-dim">
                                <th class="py-3 px-2 text-left">Produto</th>
                                <th class="py-3 px-2 text-left">Tipo</th>
                                <th class="py-3 px-2 text-left">Qtd</th>
                                <th class="py-3 px-2 text-right">Custo Médio</th>
                                <th class="py-3 px-2 text-right">Custo Total</th>
                                <th class="py-3 px-2 text-left">Vencimento</th>
                                <th class="py-3 px-2 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="ativo-modal" class="modal-overlay">
        <div class="bg-bg-card p-8 rounded-lg shadow-smooth border border-border-default w-full max-w-md">
            <h2 class="text-xl font-semibold text-brand-primary mb-4" id="ativo-modal-title">Adicionar Novo Ativo</h2>
            
            <form id="ativo-form">
                <input type="hidden" id="ativo-id" name="id">
                
                <div class="mb-4">
                    <label class="block text-text-dim mb-1">Produto (Ex: BOVA11, CDB):</label>
                    <input type="text" id="ativo-produto" name="produto" class="w-full p-2 border border-border-default rounded bg-bg-surface text-text-light focus:ring-brand-primary focus:border-brand-primary" required>
                </div>

                <div class="mb-4">
                    <label class="block text-text-dim mb-1">Tipo de Ativo:</label>
                    <select id="ativo-tipo" name="tipo_ativo" class="w-full p-2 border border-border-default rounded bg-bg-surface text-text-light focus:ring-brand-primary focus:border-brand-primary" required>
                        <option value="Ações">Ações</option>
                        <option value="FIIs">FIIs (Fundos Imobiliários)</option>
                        <option value="Renda Fixa">Renda Fixa (CDB, Tesouro)</option>
                        <option value="Fundos">Fundos</option>
                    </select>
                </div>
                
                <div class="flex gap-4 mb-4">
                    <div class="w-1/2">
                        <label class="block text-text-dim mb-1">Quantidade:</label>
                        <input type="number" id="ativo-quantidade" name="quantidade" class="w-full p-2 border border-border-default rounded bg-bg-surface text-text-light focus:ring-brand-primary focus:border-brand-primary" step="any" required>
                    </div>
                    <div class="w-1/2">
                        <label class="block text-text-dim mb-1">Custo Médio (R$/unidade):</label>
                        <input type="number" id="ativo-custo" name="custo_medio" class="w-full p-2 border border-border-default rounded bg-bg-surface text-text-light focus:ring-brand-primary focus:border-brand-primary" step="0.01" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-text-dim mb-1">Instituição Financeira:</label>
                    <input type="text" id="ativo-instituicao" name="instituicao" class="w-full p-2 border border-border-default rounded bg-bg-surface text-text-light focus:ring-brand-primary focus:border-brand-primary">
                </div>
                
                <div class="mb-6">
                    <label class="block text-text-dim mb-1">Vencimento (Opcional - Renda Fixa):</label>
                    <input type="date" id="ativo-vencimento" name="vencimento" class="w-full p-2 border border-border-default rounded bg-bg-surface text-text-light focus:ring-brand-primary focus:border-brand-primary">
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeAtivoModal()" class="py-2 px-4 rounded border border-neutral-mid bg-bg-surface text-text-light hover:bg-bg-hover transition duration-200">Cancelar</button>
                    <button type="submit" class="bg-brand-primary text-white font-bold py-2 px-4 rounded hover:bg-orange-700 transition duration-200" id="ativo-submit-btn">Salvar Ativo</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        const API_ATIVOS_URL = 'http://localhost:3000/api/ativos';
        const API_CONSOLIDADO_URL = 'http://localhost:3000/api/carteira/consolidado';

        // Função auxiliar de formatação monetária (mantida)
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
            }).format(amount);
        };

        // ======================================================
        // FUNÇÕES DE MODAL
        // ======================================================

        function openAtivoModal(mode, id = null) {
            const modal = document.getElementById('ativo-modal');
            const title = document.getElementById('ativo-modal-title');
            const form = document.getElementById('ativo-form');
            
            form.reset();
            document.getElementById('ativo-id').value = '';

            if (mode === 'new') {
                title.textContent = 'Adicionar Novo Ativo';
                modal.style.display = 'flex';
            }
            // Edição via modal (PUT) não está implementada para simplificar o protótipo.
        }

        function closeAtivoModal() {
            document.getElementById('ativo-modal').style.display = 'none';
        }

        // ======================================================
        // FUNÇÕES CRUD E CARREGAMENTO
        // ======================================================

        // Deleta o ativo
        function deleteAtivo(id) {
            if (!confirm('Tem certeza que deseja excluir este ativo?')) return;

            fetch(`${API_ATIVOS_URL}/${id}`, { method: 'DELETE' })
            .then(response => {
                if (!response.ok) throw new Error('Falha na exclusão.');
                alert('Ativo excluído com sucesso!');
                loadPortfolio(); 
            })
            .catch(error => {
                console.error('Erro ao excluir ativo:', error);
                alert('Erro ao excluir o ativo.');
            });
        }
        
        // Carrega o Resumo e Distribuição da Carteira
        function loadConsolidatedSummary() {
            fetch(API_CONSOLIDADO_URL)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-patrimonio').textContent = formatCurrency(data.totalPatrimonio);
                    
                    const container = document.getElementById('distribuicao-container');
                    container.innerHTML = '';
                    
                    if (data.distribuicao.length === 0) {
                        container.innerHTML = '<p class="text-text-dim">Nenhum investimento cadastrado.</p>';
                        return;
                    }

                    data.distribuicao.forEach(item => {
                        const percentualTexto = item.percentual.toFixed(1);

                        container.innerHTML += `
                            <div class="distribuicao-item">
                                <span class="text-text-dim">${item.tipo}</span>
                                <span class="font-semibold">${percentualTexto}% (${formatCurrency(item.valor)})</span>
                            </div>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar consolidado:', error);
                    document.getElementById('total-patrimonio').textContent = 'R$ Erro';
                });
        }
        
        // Carrega a Tabela Detalhada de Ativos
        function loadAtivosTable() {
             fetch(API_ATIVOS_URL)
                .then(response => response.json())
                .then(ativos => {
                    const tbody = document.querySelector('#table-ativos tbody');
                    tbody.innerHTML = ''; 

                    if (ativos.length === 0) {
                         tbody.innerHTML = '<tr><td colspan="7" class="text-text-dim text-center py-4">Nenhum ativo cadastrado.</td></tr>';
                        return;
                    }

                    ativos.forEach(a => {
                        const custoTotal = a.quantidade * a.custo_medio;
                        
                        tbody.innerHTML += `
                            <tr class="border-b border-border-default hover:bg-bg-hover transition duration-200">
                                <td class="py-2 px-2 font-semibold">${a.produto}</td>
                                <td class="py-2 px-2 text-text-dim">${a.tipo_ativo}</td>
                                <td class="py-2 px-2">${a.quantidade.toFixed(a.tipo_ativo === 'Renda Fixa' ? 0 : 2)}</td>
                                <td class="py-2 px-2 text-right text-text-dim">${formatCurrency(a.custo_medio)}</td>
                                <td class="py-2 px-2 text-right font-bold text-status-success">${formatCurrency(custoTotal)}</td>
                                <td class="py-2 px-2 text-text-dim">${a.vencimento ? a.vencimento : '-'}</td>
                                <td class="py-2 px-2 text-center">
                                    <span class="text-text-dim cursor-pointer hover:text-status-error transition duration-200" onclick="deleteAtivo(${a.id})">&#x2715;</span>
                                </td>
                            </tr>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar ativos:', error);
                });
        }
        
        // Função principal de carregamento
        function loadPortfolio() {
            loadConsolidatedSummary();
            loadAtivosTable();
        }

        // Lógica de Envio do Formulário (Create Ativo)
        document.getElementById('ativo-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            // Converte valores numéricos
            data.quantidade = parseFloat(data.quantidade);
            data.custo_medio = parseFloat(data.custo_medio);

            fetch(API_ATIVOS_URL, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (!response.ok) throw new Error('Falha ao salvar ativo.');
                return response.json();
            })
            .then(() => {
                alert('Ativo salvo com sucesso!');
                closeAtivoModal();
                event.target.reset();
                loadPortfolio(); // Atualiza a carteira
            })
            .catch(error => {
                console.error('Erro ao salvar ativo:', error);
                alert(`Erro ao salvar ativo. Verifique se o servidor (Node.js) está rodando na porta 3000.`);
            });
        });

        // Ação Inicial
        window.onload = loadPortfolio;
    </script>
</body>
</html>